language: rust

matrix:
  include:
    - os: linux
    - os: osx
      env: NO_TESTS_NO_DEPLOY=1
    - os: windows
      env: NO_TESTS_NO_DEPLOY=1

# Install cargo-make and rust-src rustup component
before_install:
- cargo install cargo-update || echo "cargo-update already installed"
- cargo install cargo-travis --git "https://github.com/roblabla/cargo-travis" --rev "cargo-metadata" --force || echo "cargo-travis already installed"
- cargo install cargo-make || echo "cargo-make already installed"
- cargo install-update cargo-update cargo-make cargo-xbuild
- if [ -z "${NO_TESTS_NO_DEPLOY}" ]; then rustup target install i686-unknown-linux-gnu || echo "target i686-unknown-linux-gnu already installed"; fi

script:
- cargo make iso
- cargo make iso-release
- if [ -z "${NO_TESTS_NO_DEPLOY}" ]; then cargo make test; fi
- if [ -z "${NO_TESTS_NO_DEPLOY}" ]; then cargo make doc-full; fi
- if [ -z "${NO_TESTS_NO_DEPLOY}" ]; then cargo make clippy -- -D warnings; fi

deploy:
- provider: script
  script: bash .travis/deploy.sh
  skip_cleanup: true
  on:
    branch: master
    condition: -z "${NO_TESTS_NO_DEPLOY}"

cache: cargo
before_cache:
  # Travis can't cache files that are not readable by "others"
  - chmod -R a+r $HOME/.cargo
